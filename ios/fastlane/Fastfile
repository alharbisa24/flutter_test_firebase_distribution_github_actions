default_platform(:ios)

platform :ios do
  desc "Build iOS IPA and upload to Firebase App Distribution"
  lane :firebase_distribution do
    UI.message("üöÄ Starting iOS build")

    sh("flutter clean")
    sh("flutter pub get")

    sh(
      "flutter build ipa " \
      "--release " \
      "--no-codesign " \
      "--export-method ad-hoc " \
      "--no-tree-shake-icons"
    )

    ipa_files = Dir["build/ios/ipa/*.ipa"]

    if ipa_files.empty?
      UI.user_error!("‚ùå No IPA file found in build/ios/ipa/")
    end

    ipa_path = ipa_files.first
    UI.success("‚úÖ IPA found: #{ipa_path}")

    firebase_app_distribution(
      app: "1:937001601167:ios:005384c7dc9eeda9d8c8fa",
      testers: "alharbisa24@gmail.com",
      release_notes: "iOS build from GitHub Actions",
      ipa_path: ipa_path,
      firebase_cli_token: ENV["FIREBASE_CLI_TOKEN"]
    )
  end
end
